<html>
    <head>
        <script>

var c100Obj=[{}];
var d110Obj=[{}];
var d120Obj=[{}];
var b110Obj=[{}];
var b100Obj=[{}];
var b100Flag=false;
var b110Flag=false;
var c100Flag=false;
var d110Flag=false;
var d120Flag=false;
var m100Flag=false;
var printFlag=false;



function generalToString(){
    var str="\n-----------\n";
    for(let [key,value] of Object.entries(this)){
        if(key!='toString')     str+=key + ": " + value + "\t";
    }
    return str;
}
         


function run(){
    var inputer=document.getElementById('input_1').value;
    var sp=inputer.split("\n");
    var output_1=document.getElementById('output');
    b100Flag=document.getElementById('show_b100').checked;
    b110Flag=document.getElementById('show_b110').checked;
    c100Flag=document.getElementById('show_c100').checked;
    d110Flag=document.getElementById('show_d110').checked;
    d120Flag=document.getElementById('show_d120').checked;
    m100Flag=document.getElementById('show_m100').checked;
    printFlag=document.getElementById('print_type').checked;
    printLine("Show B100: " + b100Flag);
    printLine("Show B110: " + b110Flag);
    printLine("Show C100: " + c100Flag);
    printLine("Show D110: " + d110Flag);
    printLine("Show D120: " + d120Flag);
    printLine("Show M100: " + m100Flag);
    printLine("Print to screen " + printFlag);
    var a100=[];
    var b100=[];
    var b110=[];
    var c100=[];
    var d110=[];
    var d120=[];

    printLine('Total records in file:');

    for(var i=0;i<sp.length;i++){
        let current=sp[i].substring(0,4);
        //printLine(sp[i].substring(0,4))
        switch(current){
            case 'A100':
                a100.push(sp[i]);
                break;
            case 'B100':
                b100.push(sp[i]);
                break;
            case 'B110':
                b110.push(sp[i]);
                break;
            case 'C100':
                c100.push(sp[i]);
                break;
            case 'D110':
                d110.push(sp[i]);
                break;
            case 'D120':
                d120.push(sp[i]);
                break;
        }
    }

    var C100=processC100(c100);
    //printLine(C100);
    var D110=processD110(d110);
    var D120=processD120(d120);
    var B110=processB110(b110);
    var B100=processB100(b100);
    var total_c=showTotals(C100, D110, D120, B110, B100);

}

function processC100(c100){
    c100Obj.length=0;
    for(let i=0;i<c100.length;i++){
        c100o={};  
        c100o.toString=generalToString;                  
        c100o.code=c100[i].substring(0,4);
        c100o.fileno=c100[i].substring(4,13);
        c100o.empno=c100[i].substring(13,22);
        c100o.doctype=c100[i].substr(22,3);
        c100o.docnum=c100[i].substring(25,45);
        c100o.docdate=c100[i].substring(45,53);
        c100o.dochour=c100[i].substring(53,57);
        c100o.customer=c100[i].substring(57,107);
        c100o.addrstreet=c100[i].substring(107,157);
        c100o.addrnumber=c100[i].substr(157,10);
        c100o.addrcity=c100[i].substr(167,30);
        c100o.addrzip=c100[i].substr(197,8);
        c100o.addrcountry=c100[i].substr(205,30);
        c100o.addrcountrycode=c100[i].substr(235,2);
        c100o.phone=c100[i].substr(237,15);
        c100o.taxnumber=c100[i].substr(252,9);
        c100o.duedate=c100[i].substr(261,8);
        c100o.docfxtotal=c100[i].substr(269,15);
        c100o.currency=c100[i].substr(284,3);
        c100o.totalbeforediscount=c100[i].substr(287,15);
        c100o.discount=c100[i].substr(302,15);
        c100o.totalafterdiscount=c100[i].substr(317,15);
        c100o.vattotal=c100[i].substr(332,15);
        c100o.grossamt=c100[i].substr(347,15);
        c100o.entityid=c100[i].substr(374,15);
        c100o.spaces_1=c100[i].substr(389,10);
        c100o.spaces_2=c100[i].substr(399,1);
        c100o.docdate_1=c100[i].substr(400,8);
        c100o.branch=c100[i].substr(408,7);
        c100o.user=c100[i].substr(415,9);                    
        c100o.id=id=c100[i].substr(424,7);
        c100o.spaces_3=c100[i].substr(431,13);
        c100Obj.push(c100o);
    }
    //printLine(c100Obj);
    return c100Obj;
}

function processD110(d110){
    d110Obj.length=0;
    for(let i=0;i<d110.length;i++){
        var d110o={};
        d110o.toString=generalToString;           
        d110o.code=d110[i].substr(0,4);
        d110o.fileno=parseInt(d110[i].substr(4,9));
        d110o.empno=parseInt(d110[i].substr(13,9));
        d110o.doctype=parseInt(d110[i].substr(22,3));
        d110o.docnum=parseInt(d110[i].substr(25,20));
        d110o.doclinenum=d110[i].substr(45,4);
        d110o.docmaintype=d110[i].substr(49,3);
        d110o.docmainnum=d110[i].substr(52,10);
        d110o.trantype=d110[i].substr(72,1);
        d110o.itemid=d110[i].substr(73,20);
        d110o.itemdescription=d110[i].substr(93,30);
        d110o.manufacturer=d110[i].substr(123,50);
        d110o.serialnumber=d110[i].substr(173,30);
        d110o.unittype=d110[i].substr(203,20);
        d110o.quantity=d110[i].substr(223,17);
        d110o.rate=d110[i].substr(240,15);
        d110o.discount=d110[i].substr(255,15);
        d110o.amount=d110[i].substr(270,15);
        d110o.vat=d110[i].substr(285,4);
        d110o.branch=d110[i].substr(289,7);
        d110o.duedate=d110[i].substr(296,8);
        d110o.id=d110[i].substr(304,7);
        d110o.branchid=d110[i].substr(311,7);
        d110o.space=d110[i].substr(318,21);
        d110o.rateQuantityDis=Math.abs(((parseFloat(d110o.rate)/100)*(parseFloat(d110o.quantity)/10000))-(parseFloat(d110o.amount)/100))>1?true:false;
        d110o.rqadetail=(parseFloat(d110o.rate)/100)+ "*" + (parseFloat(d110o.quantity)/10000) + "=" + (parseFloat(d110o.amount)/100);
        d110Obj.push(d110o);
    }
    //printLine(d110Obj);
    return d110Obj;
}

function processD120(d120){
    d120Obj.length=0;
    for(let i=0;i<d120.length;i++){
        d120o={};    
        d120o.toString=generalToString;               
        d120o.code=d120[i].substr(0,4);
        d120o.fileno=d120[i].substr(4,9);
        d120o.empno=d120[i].substr(13,9);
        d120o.doctype=d120[i].substr(22,3);
        d120o.docnum=d120[i].substr(25,20);
        d120o.doclinenum=d120[i].substr(45,4);
        d120o.paymentmethod=d120[i].substr(49,1);
        d120o.banknumber=d120[i].substr(50,10);
        d120o.branchnumber=d120[i].substr(60,10);
        d120o.acctnumber=d120[i].substr(70,15);
        d120o.checknumber=d120[i].substr(85,10);
        d120o.paydate=d120[i].substr(95,8);
        d120o.amount=d120[i].substr(103,15);
        d120o.clearingcompany=d120[i].substr(118,1);
        d120o.creditcard=d120[i].substr(119,20);
        d120o.credittype=d120[i].substr(139,1);
        d120o.branchid=d120[i].substr(140,7);
        d120o.docdate=d120[i].substr(147,8);
        d120o.id=d120[i].substr(155,7);
        d120o.space=d120[i].substr(162,60);
        d120Obj.push(d120o);
    }
    //printLine(d120Obj);
    return d120Obj;
}

function processB110(b110){
    b110Obj.length=0;
    for(let i=0;i<b110.length;i++){
        b110o={};
        b110o.toString=generalToString;                   
        b110o.code=b110[i].substr(0,4);
        b110o.fileno=b110[i].substr(4,9);
        b110o.empno=b110[i].substr(13,9);
        b110o.acctnumber=parseInt(b110[i].substr(22,15));
        b110o.acctname=b110[i].substr(37,50);
        b110o.bscode=b110[i].substr(87,15);
        b110o.bsdescription=b110[i].substr(102,30);
        b110o.clientstreet=b110[i].substr(132,50);
        b110o.clientno=b110[i].substr(182,10);
        b110o.clientcity=b110[i].substr(192,30);
        b110o.clientzip=b110[i].substr(222,8);
        b110o.clientcountry=b110[i].substr(230,30);
        b110o.countrycode=b110[i].substr(260,2);
        b110o.summaryacct=b110[i].substr(262,15);
        b110o.openbalance=parseFloat(b110[i].substr(277,15));
        b110o.debit=parseFloat(b110[i].substr(292,15));
        b110o.credit=parseFloat(b110[i].substr(307,15));
        b110o.accountingcode=b110[i].substr(322,4);
        b110o.entitytaxid=b110[i].substr(326,9);
        b110o.branchid=b110[i].substr(335,7);
        b110o.fxopenbalance=b110[i].substr(342,15);
        b110o.currency=b110[i].substr(357,3);
        b110o.space=b110[i].substr(360,16);
        b110Obj.push(b110o);
    }
    //printLine(b110Obj);
    return b110Obj;
}

function processB100(b100){
    b100Obj.length=0;
    for(let i=0;i<b100.length;i++){
        b100o={}; 
        b100o.toString=generalToString;                  
        b100o.code=b100[i].substr(0,4);
        b100o.fileno=b100[i].substr(4,9);
        b100o.empno=b100[i].substr(13,9);
        b100o.trannumber=parseInt(b100[i].substr(22,10));
        b100o.linenumber=b100[i].substr(32,5);
        b100o.space_1=b100[i].substr(37,8);
        b100o.trantype=b100[i].substr(45,15);
        b100o.referencenumber=b100[i].substr(60,20);
        b100o.rectyoe=b100[i].substr(80,3);
        b100o.reference_2=b100[i].substr(83,20);
        b100o.rectype_2=b100[i].substr(103,3);
        b100o.details=b100[i].substr(106,50);
        b100o.date=b100[i].substr(156,8);
        b100o.duedate=b100[i].substr(164,8);
        b100o.account=parseFloat(b100[i].substr(172,15));
        b100o.contraaccount=parseFloat(b100[i].substr(187,15));
        b100o.trandirection=parseFloat(b100[i].substr(202,1));
        b100o.currency=b100[i].substr(203,3);
        b100o.tranamount=b100[i].substr(206,15);
        b100o.tranfxamount=b100[i].substr(221,15);
        b100o.quantity=b100[i].substr(236,12);
        b100o.space_2=b100[i].substr(248,10);
        b100o.space_3=b100[i].substr(258,10);
        b100o.space_4=b100[i].substr(268,7);
        b100o.datecreated=b100[i].substr(275,8);
        b100o.createdby=b100[i].substr(283,9);
        b100o.space_5=b100[i].substr(292,25);
        b100Obj.push(b100o);
    }
    //printLine(b100Obj);
    return b100Obj;
}


function showTotals(c100, d110, d120, b110, b100){

    var titleConvert={
        100: 'salesorder',
        305: 'invoice',
        320: 'cashsale',
        330: 'creditmemo/cashrefund',
        400: 'customerdeposit/customerpayment',
        410: 'customerrefund/vendorpayment/cashrefund_2',
        500: 'purchaseorder',
        700: 'vendorbill',
        710: 'vendorcredit',
        810: 'itemreceipt',
        820: 'itemfulfillment',
        830: 'inventorytransfer/transferorder',
        840: 'inventoryadjustment',
        900: 'assemblybuild',
        910: 'assemblyunbuild',
    };
    var titles=[100,305,320,330,400,410,500,700,710,810,820,830,840,900,910]
    var total=[];
    var ur_total=[{}];
    ur_total.toString=generalToString;
    var total_d110=[];
    var total_d120=[];
    var internalid=[];
    var internalid_d110=[];
    var totalPerId=[];
    var totalPerId_d110=[];
    var totalPerId_d120=[];
    var d110_internalid=new Set();
    var d120_internalid=new Set();
    var ur_internalid=new Set();

    //Initiate ur_total
    for(let i=0;i<titles.length;i++){
        let ur_total_obj={};
        ur_total_obj.toString=generalToString;
        ur_total_obj.title=titles[i];
        ur_total_obj.totalC100=0;
        ur_total_obj.totalD110=0;
        ur_total_obj.totalD120=0;
        ur_total_obj.discrepency=0;
        ur_total.push(ur_total_obj);
    }
    //printLine(ur_total);

    //Find specific D110 line by id
    var findId=Array.from(document.getElementById('show_ids').value.split(','));
    //var findId=23030;
    //printLine(findId);
        for(let i=0;i<d110.length;i++){
            if(findId.indexOf(parseInt(d110[i].id).toString())>0){
                printLine(d110[i]);
                //printLine+=d110[i];
            }               
        }
    
        //printLine+=d110[12];
    var docLen=c100.length>d110.length ? c100.length : (d110.length>d120.length ? d110.length : d120.length);
    //printLine(docLen);

    for(let i=0;i<docLen;i++){
        for(let j=0;j<ur_total.length;j++){
            if(c100.length>i){
                let type_1=c100[i].doctype;
                if(type_1==ur_total[j].title){
                    ur_total[j].totalC100+=parseFloat(c100[i].totalbeforediscount)/100;
                    //printLine(ur_total[j].totalC100)
                }
            }  
            if(d110.length>i){
                let type_2=d110[i].doctype;
                if(type_2==ur_total[j].title){
                    ur_total[j].totalD110+=parseFloat(d110[i].amount)/100;
                }
            }  
            if(d120.length>i){
                let type_3=d120[i].doctype;
                if(type_3==ur_total[j].title){
                    ur_total[j].totalD120+=parseFloat(d120[i].amount)/100;
                }
            }
            if(ur_total[j].title=='400' || ur_total[j].title=='410'){
                ur_total[j].discrepency=Math.abs(Math.round(ur_total[j].totalC100-ur_total[j].totalD120));
                ur_total[j].discrepencyRate=(Math.abs(Math.round(ur_total[j].totalC100-ur_total[j].totalD120))/ur_total[j].totalD120)*100;
            }  
            else{
                ur_total[j].discrepency=Math.abs(Math.round(ur_total[j].totalC100-ur_total[j].totalD110));
                ur_total[j].discrepencyRate=(Math.abs(Math.round(ur_total[j].totalC100-ur_total[j].totalD110))/ur_total[j].totalD110)*100;
            } 
        }
    }

    //printLine('Summary totals:')
    //printLine(ur_total);
    print(true, ur_total, 'Summary totals:');

    //Show report records based on flags
    //printLine(b100Flag);
    print(b100Flag, b100, 'B100 Records: ');
    print(b110Flag, b110, 'B110 Records: ');
    print(c100Flag, c100, 'C100 Records: ');
    print(d110Flag, d110, 'D110 Records: ');
    print(d120Flag, d120, 'D120 Records: ');
/*
    if(b100Flag){
        printLine('B110 Account Display:')
        printLine(b110);
    }
*/
    //Analyze report dicrepencies
    
    for(let i=0;i<d120.length;i++){
        totalPerId_d120[i]=0;
        d120_internalid.add(d120[i].id);
        ur_internalid.add(parseInt(d120[i].id));
    }

    for(let i=0;i<d110.length;i++){
        totalPerId_d110[i]=0;
        d110_internalid.add(d110[i].id);
        ur_internalid.add(parseInt(d110[i].id));
    }

    for(let i=0;i<c100.length;i++){
        ur_internalid.add(parseInt(c100[i].id));
    }

    var d110_internalid_arr=Array.from(d110_internalid);
    var d120_internalid_arr=Array.from(d120_internalid);
    var ur_internalid_arr=Array.from(ur_internalid);
    var urObj=[{}];
    urObj.toString=generalToString;

    try{
        for(let i=0;i<ur_internalid_arr.length;i++){
        let ur_Obj={};
        ur_Obj.toString=generalToString;
        ur_Obj.c100Amount=0;
        ur_Obj.d110Amount=0;
        ur_Obj.d120Amount=0;
        ur_Obj.internalid=ur_internalid_arr[i];
        ur_Obj.c100Num=0;
        ur_Obj.d110Num=0;
        ur_Obj.d120Num=0;
        for(let j=0;j<c100.length;j++){
            if(parseInt(c100[j].id)==parseInt(ur_internalid_arr[i])){
                ur_Obj.c100Amount+=parseFloat(c100[j].totalbeforediscount)/100;
                ur_Obj.c100Num++;
                ///ur_Obj.docType=titleConvert[c100[i].doctype];
                typeof(titleConvert[c100[j].doctype])!=undefined?ur_Obj.docType=titleConvert[c100[j].doctype]:ur_Obj.docType=undefined;
            }
        }
        for(let j=0;j<d110.length;j++){
            if(parseInt(d110[j].id)==parseInt(ur_internalid_arr[i])){
                ur_Obj.d110Amount+=parseFloat(d110[j].amount)/100;
                ur_Obj.d110Num++;
                ur_Obj.d110rateQuantityDis=d110[j].rateQuantityDis;
                ur_Obj.d110rqadetail=d110[j].rqadetail;
                //ur_Obj.docType=titleConvert[d110[i].doctype];
                typeof(titleConvert[d110[j].doctype])!=undefined?ur_Obj.docType=titleConvert[d110[j].doctype]:ur_Obj.docType=undefined;
            }
        }
        for(let j=0;j<d120.length;j++){
            if(parseInt(d120[j].id)==parseInt(ur_internalid_arr[i])){
                ur_Obj.d120Amount+=parseFloat(d120[j].amount)/100;
                ur_Obj.d120Num++;
                //ur_Obj.docType=titleConvert[d120[i].doctype];
                typeof(titleConvert[d120[j].doctype])!=undefined?ur_Obj.docType=titleConvert[d120[j].doctype]:ur_Obj.docType=undefined;
            }
        }
        if(ur_Obj.c100Num==0 && (ur_Obj.d110Num>0 || ur_Obj.d120Num>0))   ur_Obj.exceptionC100=true;
        if(ur_Obj.d110Num==0 && ur_Obj.d120Num==0 && ur_Obj.c100Num>0)   ur_Obj.exceptionD110=true;
        urObj.push(ur_Obj);
        }  
    }catch(e){
        printLine(e);
    }
    

    //printLine(urObj);

    //Show summary discrepencies C100 D110 and D120
    var urObj_result=[{}];
    urObj_result.toString=generalToString;

    for(let i=1;i<urObj.length;i++){
        let c=urObj[i].c100Amount;
        let d1=urObj[i].d110Amount;
        let d2=urObj[i].d120Amount;
        if(Math.abs(c-d1-d2)>5 && c!=d1 && c!=d2){
            urObj_result.push(urObj[i]);
            //printLine(urObj[i]);
        }
    }

    //printLine('Transactions with discrepency between D110 and C100:');
    //printLine(urObj_result);
    print(false, urObj_result, 'Transactions with discrepency between D110 and C100:');
    
    //Restart results object
    urObj_result.length=0;

    //Show D110 lines without C100
    for(let i=1;i<urObj.length;i++){
        if(urObj[i].exceptionC100)  urObj_result.push(urObj[i]);
    }
   // printLine('D110/D120 without C100:');
   // printLine(urObj_result);
    print(true, urObj_result, 'D110/D120 without C100:');

    urObj_result.length=0;

    //Show C100 lines without D110
    for(let i=1;i<urObj.length;i++){
        if(urObj[i].exceptionD110)  urObj_result.push(urObj[i]);
    }
    //printLine('C100 without D110:');
    //printLine(urObj_result);
    print(true, urObj_result, 'C100 without D110:');

    urObj_result.length=0;

    //Show D110 with rate*quantity !=Amount
    for(let i=1;i<d110.length;i++){
        if(d110[i].rateQuantityDis){
            let tmp={};
            tmp.id=parseInt(d110[i].id);
            tmp.detail=d110[i].rqadetail;            
            urObj_result.push(tmp);
        }  
    }
    //printLine('D110 Discrepancy between Rate*Quantity to Amount:');
    //printLine(urObj_result);
    print(true, urObj_result, 'D110 Discrepancy between Rate*Quantity to Amount:');

    return total;
}

function print(flag, record, name){
    if(flag){
        //printLine(name + ' Account Display:')
       // printLine(record);
        printLine(name);
        printLine(record);
    }
}

function printLine(line){
    if(printFlag)   document.getElementById('output').value+=line.toString() + '\n';
    else typeof(line)=='string' ? console.log(line) : console.table(line);
}

            </script>
    </head>
    <body>
        <textarea id='input_1' rows="30" cols="130"></textarea><br /><br />
        <button id='runner' onclick="run()">Analyze</button><br /><br />       
        <label><b>Advanced Settings</b></label><br /><br />
        <input type='checkbox' id='show_b100'><label for='show_b100'>Show B100 Records</label><br />
        <input type='checkbox' id='show_b110'><label for='show_b110'>Show B110 Records</label><br />
        <input type='checkbox' id='show_c100'><label for='show_c100'>Show C100 Records</label><br />
        <input type='checkbox' id='show_d110'><label for='show_d110'>Show D110 Records</label><br />
        <input type='checkbox' id='show_d120'><label for='show_d120'>Show D120 Records</label><br />
        <input type='checkbox' id='show_m100'><label for='show_m100'>Show M100 Records</label><br /> 
        <input type='checkbox' id='print_type'><label for='print_type'>Print to screen</label><br />
        <label for='show_ids'>Show Specific Records(,)</label>&nbsp;<input type='text' id='show_ids'><br /><br /> 
        <textarea id='output' rows="30" cols="130"></textarea><br /><br />
    </body>
</html>